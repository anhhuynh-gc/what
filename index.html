<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keypress Duration Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e4e4e7;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { text-align: center; color: #9ca3af; margin-bottom: 24px; font-size: 0.9rem; }
    .input-area {
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    .input-area:focus-within { border-color: #60a5fa; }
    #typing-input {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: none;
      border-radius: 8px;
      padding: 16px;
      font-size: 1.2rem;
      color: #fff;
      outline: none;
    }
    #typing-input::placeholder { color: #6b7280; }
    .current-key {
      margin-top: 12px;
      font-size: 1.1rem;
      color: #a78bfa;
      min-height: 28px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }
    .stat-label { font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #60a5fa; margin-top: 4px; }
    .stat-unit { font-size: 0.7rem; color: #6b7280; }
    .chart-container {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-title { font-size: 0.9rem; color: #9ca3af; margin-bottom: 12px; }
    .chart-wrapper { position: relative; height: 200px; }
    .recent-list {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      max-height: 180px;
      overflow-y: auto;
    }
    .recent-title { font-size: 0.9rem; color: #9ca3af; margin-bottom: 10px; }
    .recent-items { display: flex; flex-wrap: wrap; gap: 6px; }
    .recent-item {
      background: rgba(96,165,250,0.15);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: monospace;
    }
    .recent-item span { color: #60a5fa; }
    .controls { text-align: center; margin-top: 16px; }
    .btn {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border: none;
      color: #fff;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; transform: scale(1.02); }
    .empty-state { color: #6b7280; font-style: italic; text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>⌨️ Keypress Duration Analyzer</h1>
    <p class="subtitle">Type below to measure how long you hold each key (printable keys only)</p>
    
    <div class="input-area">
      <input type="text" id="typing-input" placeholder="Start typing here..." autocomplete="off">
      <div class="current-key" id="current-key"></div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Samples</div>
        <div class="stat-value" id="stat-count">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Mean</div>
        <div class="stat-value" id="stat-mean">--</div>
        <div class="stat-unit">ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Median</div>
        <div class="stat-value" id="stat-median">--</div>
        <div class="stat-unit">ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Std Dev</div>
        <div class="stat-value" id="stat-std">--</div>
        <div class="stat-unit">ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">P95</div>
        <div class="stat-value" id="stat-p95">--</div>
        <div class="stat-unit">ms</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">P99</div>
        <div class="stat-value" id="stat-p99">--</div>
        <div class="stat-unit">ms</div>
      </div>
    </div>
    
    <div class="chart-container">
      <div class="chart-title">Distribution (ms)</div>
      <div class="chart-wrapper">
        <canvas id="histogram-chart"></canvas>
      </div>
    </div>
    
    <div class="recent-list">
      <div class="recent-title">Recent Keypresses</div>
      <div class="recent-items" id="recent-items">
        <div class="empty-state">No data yet</div>
      </div>
    </div>
    
    <div class="controls">
      <button class="btn" id="clear-btn">Clear Data</button>
    </div>
  </div>

  <script>
    const durations = [];
    const recentData = [];
    const pendingKeys = new Map();
    const MAX_RECENT = 50;
    const BINS = 15;

    // Initialize Chart.js histogram
    const ctx = document.getElementById('histogram-chart').getContext('2d');
    const histogramChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'Frequency',
          data: [],
          backgroundColor: 'rgba(96, 165, 250, 0.7)',
          borderColor: 'rgba(96, 165, 250, 1)',
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: function(items) {
                return items[0].label + ' ms';
              },
              label: function(item) {
                return item.raw + ' samples';
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Duration (ms)', color: '#9ca3af' },
            ticks: { color: '#9ca3af' },
            grid: { color: 'rgba(255,255,255,0.05)' }
          },
          y: {
            title: { display: true, text: 'Count', color: '#9ca3af' },
            ticks: { color: '#9ca3af', stepSize: 1 },
            grid: { color: 'rgba(255,255,255,0.05)' },
            beginAtZero: true
          }
        }
      }
    });

    function isPrintableKeyEvent(event) {
      if (event.keyCode === 229)
        return true; // temporarily fix to Android
      if (event.keyCode === 231)
        return true; // temporarily fix to Android / Windows App
      var codeUnit = event.key.charCodeAt(0);
      var isLeadSurrogate = (codeUnit >= 0xD800 && codeUnit <= 0xDFFF);
      return event.key.length == 1 || (event.key.length == 2 && isLeadSurrogate);
    }

    function percentile(arr, p) {
      if (arr.length === 0) return 0;
      const sorted = [...arr].sort((a, b) => a - b);
      const idx = (p / 100) * (sorted.length - 1);
      const lower = Math.floor(idx);
      const upper = Math.ceil(idx);
      if (lower === upper) return sorted[lower];
      return sorted[lower] + (sorted[upper] - sorted[lower]) * (idx - lower);
    }

    function mean(arr) {
      return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
    }

    function stdDev(arr) {
      if (arr.length < 2) return 0;
      const m = mean(arr);
      return Math.sqrt(arr.reduce((sum, v) => sum + (v - m) ** 2, 0) / arr.length);
    }

    function updateStats() {
      document.getElementById('stat-count').textContent = durations.length;
      if (durations.length === 0) {
        ['mean', 'median', 'std', 'p95', 'p99'].forEach(function(id) {
          document.getElementById('stat-' + id).textContent = '--';
        });
        return;
      }
      document.getElementById('stat-mean').textContent = mean(durations).toFixed(1);
      document.getElementById('stat-median').textContent = percentile(durations, 50).toFixed(1);
      document.getElementById('stat-std').textContent = stdDev(durations).toFixed(1);
      document.getElementById('stat-p95').textContent = percentile(durations, 95).toFixed(1);
      document.getElementById('stat-p99').textContent = percentile(durations, 99).toFixed(1);
    }

    function updateHistogram() {
      if (durations.length === 0) {
        histogramChart.data.labels = [];
        histogramChart.data.datasets[0].data = [];
        histogramChart.update();
        return;
      }

      const min = Math.min.apply(null, durations);
      const max = Math.max.apply(null, durations);
      const range = max - min || 1;
      const binSize = range / BINS;
      
      const bins = [];
      const labels = [];
      
      for (var i = 0; i < BINS; i++) {
        bins.push(0);
        var binStart = Math.round(min + i * binSize);
        var binEnd = Math.round(min + (i + 1) * binSize);
        labels.push(binStart + '-' + binEnd);
      }

      for (var j = 0; j < durations.length; j++) {
        var d = durations[j];
        var idx = Math.floor((d - min) / binSize);
        if (idx >= BINS) idx = BINS - 1;
        bins[idx]++;
      }

      histogramChart.data.labels = labels;
      histogramChart.data.datasets[0].data = bins;
      histogramChart.update();
    }

    function updateRecent() {
      var container = document.getElementById('recent-items');
      if (recentData.length === 0) {
        container.innerHTML = '<div class="empty-state">No data yet</div>';
        return;
      }
      var html = '';
      var start = Math.max(0, recentData.length - 30);
      for (var i = recentData.length - 1; i >= start; i--) {
        var d = recentData[i];
        var displayKey = d.key === ' ' ? '␣' : d.key;
        html += '<div class="recent-item">"' + displayKey + '" <span>' + d.duration + 'ms</span></div>';
      }
      container.innerHTML = html;
    }

    function recordDuration(key, duration) {
      durations.push(duration);
      recentData.push({ key: key, duration: duration });
      if (recentData.length > MAX_RECENT) recentData.shift();
      updateStats();
      updateHistogram();
      updateRecent();
    }

    var input = document.getElementById('typing-input');
    var currentKeyEl = document.getElementById('current-key');

    input.addEventListener('keydown', function(e) {
      if (!isPrintableKeyEvent(e)) return;
      if (e.repeat) return;
      var keyId = e.key;
      if (!pendingKeys.has(keyId)) {
        pendingKeys.set(keyId, performance.now());
        var displayKey = keyId === ' ' ? 'Space' : keyId;
        currentKeyEl.textContent = 'Holding: "' + displayKey + '"';
      }
    });

    input.addEventListener('keyup', function(e) {
      if (!isPrintableKeyEvent(e)) return;
      var keyId = e.key;
      if (pendingKeys.has(keyId) || isUnidentifiedKeycode(e)) {
        var start = pendingKeys.get(keyId);
        var duration = Math.round(performance.now() - start);
        pendingKeys.delete(keyId);
        recordDuration(e.key, duration);
        var displayKey = keyId === ' ' ? 'Space' : keyId;
        currentKeyEl.textContent = 'Released: "' + displayKey + '" → ' + duration + 'ms';
      }
    });

    function isUnidentifiedKeycode(e) {
      return e.keyCode === 229 || e.keyCode === 231;
    }

    document.getElementById('clear-btn').addEventListener('click', function() {
      durations.length = 0;
      recentData.length = 0;
      pendingKeys.clear();
      input.value = '';
      currentKeyEl.textContent = '';
      updateStats();
      updateHistogram();
      updateRecent();
    });

    input.focus();
  </script>
</body>
</html>
